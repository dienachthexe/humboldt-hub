<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Digital Humboldt</title>
<style>
    /* Cal Poly Humboldt Branding */
    :root { 
        --primary: #004C46; /* Humboldt Green */
        --accent: #F2A900;  /* Humboldt Gold */
        --text: #2c3e50;
        --light-bg: #f7f9fb;
    }

    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        background: var(--light-bg); 
        margin: 0; 
        padding: 20px; 
        color: var(--text);
    }

    header { text-align: center; margin-bottom: 24px; }
    h1 { color: var(--primary); margin: 0 0 4px 0; font-size: 2rem; }
    p { color: #666; margin-top: 0; }

    /* Search Bar Optimization */
    .search-container { max-width: 720px; margin: 10px auto; position: relative; }
    #search { 
        width: 100%; 
        padding: 15px 25px; 
        border: 2px solid #ddd; 
        border-radius: 30px; 
        font-size: 18px; 
        outline: none; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    #search:focus { 
        border-color: var(--primary); 
        box-shadow: 0 4px 12px rgba(0,76,70,0.15); 
    }

    #counter { text-align: center; color: #7f8c8d; font-size: 0.9rem; margin: 12px 0; min-height: 1.2em; }

    /* Topic Grid (The New Landing Page UI) */
    .topic-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
        gap: 16px; 
        max-width: 800px; 
        margin: 20px auto 40px; 
    }
    .topic-card {
        background: #fff;
        padding: 24px 15px;
        border-radius: 12px;
        text-align: center;
        border: 1px solid #e7eaef;
        cursor: pointer;
        font-weight: 600;
        color: var(--primary);
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .topic-card:hover { 
        transform: translateY(-4px); 
        border-color: var(--accent);
        box-shadow: 0 6px 12px rgba(0,0,0,0.08);
        background: #fffdf5;
    }
    .topic-icon { font-size: 2rem; display: block; margin-bottom: 8px; }

    /* Results list (catalog style) */
    .results { max-width: 1000px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }
    .result {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 16px; 
        align-items: start;
        background: #fff; 
        border: 1px solid #e7eaef; 
        border-radius: 10px; 
        padding: 15px;
        cursor: pointer;
        transition: border 0.2s, background 0.2s;
    }
    .result:hover {
        background: #f0f4f8;
        border-color: var(--primary);
    }
    .thumb { width: 120px; height: 90px; object-fit: cover; border-radius: 6px; background: #eef1f5; }
    .title { margin: 0; font-size: 1.1rem; color: var(--primary); line-height: 1.3; }
    .meta { margin-top: 6px; color: #6b7785; font-size: 0.85rem; }
    .chip { display: inline-block; margin-right: 12px; background: #f1f3f6; padding: 2px 8px; border-radius: 4px; }

    /* Modal Styling */
    .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(3px); }
    .modal-content { 
        background: #fff; 
        margin: 5% auto; 
        padding: 30px; 
        width: 90%; 
        max-width: 850px; 
        border-radius: 16px; 
        position: relative; 
        display: grid; 
        grid-template-columns: 300px 1fr; 
        gap: 24px; 
        max-height: 85vh;
        overflow-y: auto;
    }
    @media (max-width: 700px) {
        .modal-content { grid-template-columns: 1fr; margin: 2% auto; padding: 20px; }
        .topic-grid { grid-template-columns: 1fr 1fr; }
    }
    .close { position: absolute; right: 20px; top: 15px; font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
    .close:hover { color: var(--primary); }
    
    .modal-img { width: 100%; height: auto; max-height: 400px; object-fit: contain; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; }
    .modal-info h2 { margin: 0 0 10px 0; color: var(--primary); font-size: 1.5rem; }
    .meta-label { font-weight: 700; color: #6b7785; text-transform: uppercase; font-size: 0.75rem; margin-top: 15px; letter-spacing: 0.5px; }
    
    .btn { 
        display: inline-block; 
        background: var(--primary); 
        color: #fff; 
        padding: 12px 20px; 
        text-decoration: none; 
        border-radius: 8px; 
        margin-top: 20px; 
        font-weight: 600;
        text-align: center;
        transition: background 0.2s;
    }
    .btn:hover { background: #00332e; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
</style>
<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
</head>
<body>

<header>
  <h1>Digital Humboldt</h1>
  <p>Search the Historical Collections of &amp; Humboldt County</p>
  <div class="search-container">
    <input id="search" type="text" placeholder="Search by title, subject, or description‚Ä¶"/>
  </div>
  <div id="counter">Loading records‚Ä¶</div>
</header>

<div id="results" class="results"></div>
<div class="topic-grid">
  <div class="topic-card" onclick="runSearch('Map')">
    <span class="topic-icon">üó∫Ô∏è</span> Maps
  </div>
  <div class="topic-card" onclick="runSearch('Finding Aid')">
    <span class="topic-icon">üå≤</span> Finding Aids
  </div>
  <div class="topic-card" onclick="runSearch('Native American')">
    <span class="topic-icon">üè∫</span> Indigenous History
  </div>
  <div class="topic-card" onclick="runSearch('Photograph')">
    <span class="topic-icon">üì∏</span> Photographs
  </div>
</div>
<div style="text-align:center; margin: 20px;">
    <button id="loadMoreBtn" class="btn" style="display:none;" onclick="loadMore()">Load More Results</button>
</div>
<div id="itemModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <img id="modalImg" class="modal-img" src="" alt="Preview"/>
    <div class="modal-info">
      <h2 id="modalTitle"></h2>
      <div id="modalMeta"></div>
      <a id="modalLink" href="" target="_blank" rel="noopener" class="btn">View Original Record</a>
    </div>
  </div>
</div>

<script>
let data = [];
  let fuse; // This is our fuzzy search engine
  let currentFilteredItems = []; 
  const elResults = document.getElementById('results');
  const elCounter = document.getElementById('counter');
  const elSearch = document.getElementById('search');
  const modal = document.getElementById('itemModal');

  // Helpers
  const normalizeYear = d => {
    if (!d) return "";
    const m = String(d).match(/(19|20)\d{2}/); 
    return m ? m[0] : String(d);
  };

  // 1. Load Data and Initialize Search Engine
  fetch('data.json')
    .then(response => {
      if (!response.ok) throw new Error("Network response was not ok");
      return response.json();
    })
    .then(jsonData => {
      // Clean up dates as we load
      data = jsonData.map(item => ({
        ...item,
        Date: normalizeYear(item.Date)
      }));

      // Set up the Fuzzy Search Engine
      const options = {
        keys: ['Title', 'Description', 'Subject', 'Collection'],
        threshold: 0.3, // 0.0 is perfect match, 1.0 is anything. 0.3 is good for typos.
        ignoreLocation: true,
		useExtendedSearch: true
      };
      fuse = new Fuse(data, options);

      elCounter.textContent = `Ready to search across ${data.length.toLocaleString()} records`;
      // We don't call render(data) here because we want the page to stay clean at first
    })
    .catch(err => {
      console.error("Error loading JSON:", err);
      elCounter.textContent = "Error loading database.";
    });

let displayLimit = 100; // Keep track of how many to show
  let lastSearchResults = []; // Keep track of the full list of matches

  // 2. Optimized Render Function
  function render(items) {
    lastSearchResults = items; // Store the full list so "Load More" can access it
    currentFilteredItems = items.slice(0, displayLimit); 
    
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    
    if (items.length === 0) {
        elCounter.textContent = "No matching records found.";
        elResults.innerHTML = '';
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
        return;
    }

    // Show the button only if there are more items left to display
    if (loadMoreBtn) {
      loadMoreBtn.style.display = items.length > displayLimit ? 'inline-block' : 'none';
    }

    elCounter.textContent = `Showing top ${currentFilteredItems.length} of ${items.length.toLocaleString()} matches`;

    elResults.innerHTML = currentFilteredItems.map((item, index) => {
      return `
        <div class="result" onclick="openModalByIndex(${index})">
          <img class="thumb" src="${item.Thumbnail}" alt="thumbnail" onerror="this.src='https://img.icons8.com/color/80/document.png'">
          <div>
            <h3 class="title">${item.Title || "(untitled)"}</h3>
            <div class="meta">
              <span class="chip"><strong>${item.Institution}</strong></span>
              ${item.Collection ? `<span class="chip">Collection: ${item.Collection}</span>` : ""}
              ${item.Date ? `<span class="chip">Date: ${item.Date}</span>` : ""}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // New function for the button click
  function loadMore() {
    displayLimit += 100; // Increase the count by 100
    render(lastSearchResults); // Re-render with the new limit
  }

  // 3. Search Logic (Resetting the limit on new search)
  elSearch.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    const topicGrid = document.querySelector('.topic-grid');
    
    // Reset limit for every new search
    displayLimit = 100;

    if (query.length < 2) {
      elResults.innerHTML = ""; 
      if (topicGrid) topicGrid.style.display = "grid";
      document.getElementById('loadMoreBtn').style.display = 'none';
      elCounter.textContent = `Ready to search across ${data.length.toLocaleString()} records`;
      return;
    }

    if (topicGrid) topicGrid.style.display = "none";
    
    // This part forces Fuse to find EVERY word instead of ANY word
    const andQuery = query.split(' ').filter(w => w).map(w => `'${w}`).join(' ');
    const results = fuse.search(andQuery);
    
    render(results.map(r => r.item));
  });

// 4. Topic Card Helper
function runSearch(term) {
    elSearch.value = term;
    
    // Add this line to hide the cards when a topic is clicked:
    const topicGrid = document.querySelector('.topic-grid');
    if (topicGrid) topicGrid.style.display = "none";

    const results = fuse.search(term);
    render(results.map(r => r.item));
    elSearch.focus();
}

  // 5. Modal Logic (Unchanged)
  function openModalByIndex(index) {
    const item = currentFilteredItems[index];
    if (!item) return;

    document.getElementById('modalTitle').textContent = item.Title || "(untitled)";
    document.getElementById('modalImg').src = item.Thumbnail;
    document.getElementById('modalLink').href = item.Link || "#";

    const fields = [
      { label: 'Description', value: item.Description },
      { label: 'Subjects', value: item.Subject },
      { label: 'Collection', value: item.Collection },
      { label: 'Institution', value: item.Institution },
      { label: 'Date', value: item.Date }
    ];

    document.getElementById('modalMeta').innerHTML = fields
      .filter(f => f.value && String(f.value).trim() !== "")
      .map(f => `<div class="meta-label">${f.label}</div><div>${f.value}</div>`).join('');
    
    modal.style.display = "block";
    modal.setAttribute('aria-hidden', 'false');
  }

  function closeModal() { 
    modal.style.display = "none"; 
    modal.setAttribute('aria-hidden', 'true'); 
  }

  window.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
</script>

</body>
</html>